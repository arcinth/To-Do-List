<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>To-Do List</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no" />
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css" integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous" />
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <style>
      :root {
        --bg-body: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --bg-card: #ffffff;
        --bg-header: rgba(255, 255, 255, 0.95);
        --bg-input: #f8f9fa;
        --text-primary: #2d3748;
        --text-secondary: #718096;
        --border-color: #e2e8f0;
        --primary-accent: #667eea;
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        
        --priority-high: #ef4444;
        --priority-medium: #f59e0b;
        --priority-low: #3b82f6;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        background: var(--bg-body);
        color: var(--text-primary);
        font-family: 'Inter', sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        min-height: 100vh;
      }
      
      h1, h2, h3, h4, h5 {
        color: var(--text-primary);
        font-family: 'Poppins', sans-serif;
        font-weight: 600;
      }

      /* Header */
      header {
        background: var(--bg-header);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        box-shadow: var(--shadow);
        position: sticky;
        top: 0;
        z-index: 100;
        padding: 15px 0;
      }
      
      header .navbar {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      header h1 {
        font-size: 1.75rem;
        margin: 0;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .logo {
        font-size: 1.5rem;
        font-weight: 700;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-decoration: none;
      }

      /* Main Container */
      .app-container {
        max-width: 1100px;
        margin: 40px auto;
        padding: 0 20px;
      }

      /* Clock */
      .Clock {
        background: var(--bg-card);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: var(--shadow-lg);
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.5);
      }
      
      #time {
        font-size: 3rem;
        font-weight: 700;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 10px;
      }
      
      .week {
        display: flex;
        gap: 15px;
        justify-content: center;
        align-items: center;
        color: var(--text-secondary);
        font-size: 1rem;
      }

      /* Stats */
      .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      
      .stat-card {
        background: var(--bg-card);
        border-radius: 20px;
        padding: 30px;
        box-shadow: var(--shadow-lg);
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.5);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }
      
      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-xl);
      }
      
      .stat-card h1 {
        font-size: 3rem;
        margin-bottom: 10px;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      
      .stat-card h5 {
        font-size: 1.1rem;
        margin-bottom: 5px;
        color: var(--text-primary);
      }
      
      .stat-card p {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin: 0;
      }

      /* Progress */
      .progress-wrapper {
        background: var(--bg-card);
        padding: 30px;
        border-radius: 20px;
        box-shadow: var(--shadow-lg);
        margin-bottom: 30px;
        border: 1px solid rgba(255, 255, 255, 0.5);
      }
      
      .progress {
        height: 1.2rem !important;
        border-radius: 10px;
        background-color: #e9ecef;
        overflow: hidden;
      }
      
      .progress-bar {
        background: var(--primary-gradient);
        font-size: 0.85rem;
        font-weight: 600;
        transition: width 0.6s ease;
      }

      /* Controls */
      .controls-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
      }
      
      .btn-primary-gradient {
        background: var(--primary-gradient);
        color: white;
        border: none;
        padding: 16px 24px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1rem;
        transition: all 0.3s ease;
        box-shadow: var(--shadow);
        cursor: pointer;
      }
      
      .btn-primary-gradient:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-xl);
      }
      
      .btn-outline-secondary {
        background: var(--bg-card);
        border: 2px solid var(--border-color);
        color: var(--text-primary);
        padding: 16px 24px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1rem;
        transition: all 0.3s ease;
        cursor: pointer;
      }
      
      .btn-outline-secondary:hover {
        background: #f8f9fa;
        border-color: var(--primary-accent);
        transform: translateY(-2px);
        box-shadow: var(--shadow);
      }
      
      /* Forms */
      .form-control, .form-select {
        background-color: var(--bg-input) !important;
        color: var(--text-primary) !important;
        border: 2px solid var(--border-color) !important;
        border-radius: 12px;
        padding: 14px 20px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
      }
      
      .form-control:focus, .form-select:focus {
        border-color: var(--primary-accent) !important;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1) !important;
        background-color: #fff !important;
      }

      .search-container { 
        position: relative; 
      }
      
      .search-icon-custom {
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
        pointer-events: none;
      }
      
      #searchInput {
        padding-left: 50px !important;
      }

      /* Modals */
      .modal-content {
        background: var(--bg-card);
        border: none;
        border-radius: 20px;
        box-shadow: var(--shadow-xl);
      }
      
      .modal-header {
        border-bottom: 1px solid var(--border-color);
        padding: 24px;
      }
      
      .modal-body {
        padding: 24px;
      }
      
      .modal-body label {
        color: var(--text-secondary);
        font-weight: 500;
        margin-bottom: 8px;
      }

      /* Tasks */
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      .todo-list {
        list-style: none;
        padding: 0;
      }
      
      .todo {
        display: flex;
        align-items: stretch;
        background: var(--bg-card);
        border-radius: 16px;
        margin-bottom: 16px;
        transition: all 0.3s ease;
        overflow: hidden;
        animation: fadeIn 0.5s ease;
        box-shadow: var(--shadow);
        border: 1px solid rgba(255, 255, 255, 0.5);
      }
      
      .todo:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-xl);
      }
      
      .todo-item {
        flex-grow: 1;
        list-style: none;
        padding: 0;
      }
      
      .task-content {
        padding: 24px;
      }
      
      .task-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
      }
      
      .task-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin: 0;
        color: var(--text-primary);
      }
      
      .badge {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 6px 12px;
        border-radius: 8px;
      }
      
      .high-priority { background: var(--priority-high) !important; color: #fff; }
      .medium-priority { background: var(--priority-medium) !important; color: #fff; }
      .low-priority { background: var(--priority-low) !important; color: #fff; }
      
      .task-dates {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-bottom: 12px;
      }
      
      .subtasks-section {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border-color);
      }
      
      .subtasks-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      
      .subtask-item {
        color: var(--text-secondary);
        padding: 8px 0;
        font-size: 0.9rem;
      }
      
      .subtask-item.completed {
        text-decoration: line-through;
        opacity: 0.6;
      }
      
      .notes-section {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border-color);
      }
      
      .notes-section summary {
        cursor: pointer;
        color: var(--text-secondary);
        font-weight: 500;
      }
      
      .notes-text {
        margin-top: 12px;
        padding: 16px;
        background: var(--bg-input);
        border-radius: 12px;
        color: var(--text-secondary);
      }
      
      .complete-btn, .trash-btn {
        background: transparent;
        border: none;
        color: var(--text-secondary);
        font-size: 1.2rem;
        padding: 0 20px;
        transition: all 0.3s ease;
        cursor: pointer;
        min-width: 70px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .complete-btn:hover {
        background: #d1fae5;
        color: #059669;
      }
      
      .trash-btn:hover {
        background: #fee2e2;
        color: #dc2626;
      }
      
      .todo.completed {
        opacity: 0.7;
        background: #f9fafb;
      }
      
      .todo.completed .task-title {
        text-decoration: line-through;
      }

      /* Empty State */
      #emptyMessage {
        text-align: center;
        padding: 60px 20px;
        background: var(--bg-card);
        border-radius: 20px;
        box-shadow: var(--shadow);
      }
      
      #emptyMessage h3 {
        font-size: 1.5rem;
        margin-bottom: 10px;
        color: var(--text-primary);
      }
      
      #emptyMessage p {
        color: var(--text-secondary);
        font-size: 1rem;
      }

      /* Delete All Button */
      .delete-all {
        background: var(--bg-card);
        border: 2px solid var(--priority-high);
        color: var(--priority-high);
        padding: 14px 28px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        margin: 30px auto;
        display: block;
        transition: all 0.3s ease;
        box-shadow: var(--shadow);
      }
      
      .delete-all:hover {
        background: var(--priority-high);
        color: white;
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }

      /* Scroll to Top */
      #scrollTop {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: var(--primary-gradient);
        color: white;
        border: none;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        font-size: 1.5rem;
        cursor: pointer;
        display: none;
        box-shadow: var(--shadow-lg);
        transition: all 0.3s ease;
        z-index: 999;
      }
      
      #scrollTop:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-xl);
      }

      /* Welcome Modal */
      .welcome-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      
      .welcome-content {
        background: var(--bg-card);
        padding: 50px;
        border-radius: 24px;
        max-width: 500px;
        width: 90%;
        text-align: center;
        box-shadow: var(--shadow-xl);
        animation: fadeIn 0.5s ease;
      }
      
      .welcome-content h2 {
        font-size: 2rem;
        margin-bottom: 20px;
      }
      
      .welcome-content p {
        font-size: 1.1rem;
        color: var(--text-secondary);
        line-height: 1.6;
        margin-bottom: 30px;
      }

      /* Subtasks Wrapper */
      .subtasks {
        background: var(--bg-input);
        border: 2px solid var(--border-color);
        border-radius: 16px;
        padding: 20px;
      }
      
      .subtask-row {
        background: white;
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 10px;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .stats-container {
          grid-template-columns: 1fr;
        }
        
        .controls-grid {
          grid-template-columns: 1fr;
        }
        
        #time {
          font-size: 2rem;
        }
        
        .stat-card h1 {
          font-size: 2.5rem;
        }
        
        header h1 {
          font-size: 1.5rem;
        }
      }

      /* Flatpickr Custom Styles */
      .flatpickr-calendar {
        background: var(--bg-card) !important;
        border: none !important;
        box-shadow: var(--shadow-xl) !important;
        border-radius: 16px !important;
      }
      
      .flatpickr-day.selected {
        background: var(--primary-gradient) !important;
        border-color: transparent !important;
      }
      
      .flatpickr-day:hover {
        background: var(--primary-accent) !important;
        color: white !important;
      }

      /* Timeline Highlights */
      .badge-start {
        background: #7e00b5 !important;
        color: white !important;
        font-weight: bold !important;
      }
      
      .badge-due {
        background: #059669 !important;
        color: white !important;
        font-weight: bold !important;
      }
      
      .reminder-highlight {
        background: #fbbf24 !important;
        color: #000 !important;
        font-weight: bold !important;
      }
      
      .in-range-custom {
        background: rgba(102, 126, 234, 0.2) !important;
      }

      /* Analysis Modal */
      #analysisModal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      }
      
      #analysisModal > div {
        background: var(--bg-card);
        padding: 30px;
        border-radius: 20px;
        max-width: 700px;
        width: 90%;
        box-shadow: var(--shadow-xl);
      }
    </style>
</head>

<body>
    <!-- Welcome Modal -->
    <div id="welcomeModal" class="welcome-modal">
        <div class="welcome-content">
            <h2>👋 Hello, <span id="userName">User</span>!</h2>
            <p>Get ready to organize your tasks, set priorities, and stay on top of your day. Let's make today productive!</p>
            <button id="closeWelcome" class="btn-primary-gradient">Let's Go!</button>
        </div>
    </div>

    <!-- Header -->
    <header>
        <div class="navbar">
            <a href="#" class="logo">✓ TaskMaster</a>
            <h1>To-Do List</h1>
            <button onclick="logout()" class="btn-primary-gradient" style="padding: 10px 20px;">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </header>

    <!-- Main App -->
    <main class="app-container">
        <!-- Clock -->
        <div class="Clock">
            <div id="time"></div>
            <div class="week">
                <div id="day"></div>
                <span>•</span>
                <div id="date"></div>
            </div>
        </div>

        <!-- Stats -->
        <section class="stats-container">
            <div class="stat-card">
                <h1><span id="state1">0</span></h1>
                <h5>Total Tasks</h5>
                <p>All tasks you have created</p>
            </div>
            <div class="stat-card">
                <h1><span id="state2">0</span></h1>
                <h5>Remaining To Do</h5>
                <p>Tasks remaining to complete</p>
            </div>
            <div class="stat-card">
                <h1><span id="state3">0</span></h1>
                <h5>Completed Tasks</h5>
                <p>Total tasks completed</p>
            </div>
        </section>

        <!-- Progress -->
        <div class="progress-wrapper">
            <h5 class="text-center mb-3">Overall Progress</h5>
            <div class="progress">
                <div id="taskProgressBar" class="progress-bar" role="progressbar" style="width: 0%;">0%</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls-grid">
            <button type="button" class="btn-primary-gradient" data-bs-toggle="modal" data-bs-target="#taskModal">
                <i class="fas fa-plus-circle me-2"></i>Add New Task
            </button>
            <button class="btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#timelineModal">
                <i class="far fa-calendar-alt me-2"></i>Visual Timeline
            </button>
            <div class="search-container">
                <i class="fa fa-search search-icon-custom"></i>
                <input type="text" id="searchInput" class="form-control" placeholder="Search tasks..." oninput="searchTasks()">
            </div>
            <select id="sortBy" class="form-select" onchange="sortTasks()">
                <option value="">📊 Sort By...</option>
                <option value="priority">🔥 Priority</option>
                <option value="dueDate">📅 Due Date</option>
            </select>
        </div>

        <!-- Empty State -->
        <div id="emptyMessage" style="display: block;">
            <h3>📝 Your List is Empty!</h3>
            <p>Click "Add New Task" to get started on your productivity journey.</p>
        </div>

        <!-- Task List -->
        <div class="todo-container">
            <ul class="todo-list"></ul>
        </div>

        <!-- Delete All -->
        <button class="delete-all" onclick="deleteAllTasks()">
            <i class="fas fa-trash-alt me-2"></i>Delete All Tasks
        </button>
    </main>

    <!-- Task Modal -->
    <div class="modal fade" id="taskModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5><strong>Add a New Task</strong></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="taskForm" class="row g-3">
                        <div class="col-md-6">
                            <label for="taskTitle" class="form-label">Task Title</label>
                            <input id="taskTitle" type="text" class="form-control" placeholder="Enter task title..." required>
                        </div>
                        <div class="col-md-3">
                            <label for="priorityInput" class="form-label">Priority</label>
                            <select id="priorityInput" class="form-select">
                                <option value="High">High</option>
                                <option value="Medium" selected>Medium</option>
                                <option value="Low">Low</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="stageSelect" class="form-label">Task Stage</label>
                            <select id="stageSelect" class="form-select">
                                <option value="pending" selected>Pending</option>
                                <option value="in-progress">In Progress</option>
                                <option value="partially-completed">Partially Completed</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="startDate" class="form-label">Start Date</label>
                            <input id="startDate" type="date" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label for="dueDate" class="form-label">Due Date</label>
                            <input id="dueDate" type="date" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label for="deadlineTime" class="form-label">Reminder</label>
                            <input id="deadlineTime" type="datetime-local" class="form-control">
                        </div>
                        <div class="col-12">
                            <label for="taskNotes" class="form-label">Notes</label>
                            <textarea id="taskNotes" class="form-control" rows="3" placeholder="Add any additional notes..."></textarea>
                        </div>
                        <div class="col-12">
                            <div class="subtasks">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="mb-0"><strong>Subtasks</strong></h5>
                                    <button id="addSubtaskBtn" type="button" class="btn btn-sm btn-primary">
                                        <i class="fas fa-plus me-1"></i>Add Subtask
                                    </button>
                                </div>
                                <div id="subtask-list"></div>
                            </div>
                        </div>
                        <div class="col-12 text-end">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-check me-2"></i>Add Task
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Timeline Modal -->
    <div class="modal fade" id="timelineModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5><strong>Visual Timeline</strong></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="calendarNotice" class="text-center mb-3">Loading tasks...</div>
                    <div class="timeline-legend mb-3 d-flex gap-2 justify-content-center">
                        <span class="badge" style="background:#7e00b5;">Start</span>
                        <span class="badge bg-success">Due</span>
                        <span class="badge" style="background:#fbbf24;color:#000;">Reminder</span>
                    </div>
                    <div id="calendar"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Modal -->
    <div id="analysisModal">
        <div>
            <h2 class="text-center mb-3">📊 Productivity Analysis</h2>
            <p id="productivityScore" class="text-center" style="font-size:1.2rem; font-weight:600;"></p>
            <div style="height:300px;">
                <canvas id="productivityChart"></canvas>
            </div>
            <button onclick="closeAnalysisModal()" class="btn btn-danger mt-3">Close</button>
        </div>
    </div>

    <!-- Scroll to Top -->
    <button onclick="scrollWindow()" id="scrollTop" title="Go to top">↑</button>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
        // Logout Function
        function logout() {
            if (confirm("Are you sure you want to logout?")) {
                alert("You have been logged out successfully!");
                window.location.href = "login.html";
            }
        }

        // Clock
        function updateClock() {
            const now = new Date();
            const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const date = now.toLocaleDateString([], { day: '2-digit', month: 'short', year: 'numeric' });
            const day = now.toLocaleDateString([], { weekday: 'long' });
            document.getElementById('time').textContent = time;
            document.getElementById('date').textContent = date;
            document.getElementById('day').textContent = day;
        }
        updateClock();
        setInterval(updateClock, 1000);

        // Welcome Modal
        window.onload = function() {
            const modal = document.getElementById("welcomeModal");
            const closeBtn = document.getElementById("closeWelcome");
            const username = "User";
            document.getElementById("userName").textContent = username;
            modal.style.display = "flex";
            closeBtn.onclick = function() {
                modal.style.display = "none";
            };
        };

        // Scroll to Top
        const scrollBtn = document.getElementById("scrollTop");
        window.onscroll = function() {
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                scrollBtn.style.display = "block";
            } else {
                scrollBtn.style.display = "none";
            }
        };
        
        function scrollWindow() {
            window.scrollTo({ top: 0, behavior: "smooth" });
        }

        // Search Tasks
        function searchTasks() {
            const searchInput = document.getElementById("searchInput").value.toLowerCase();
            const tasks = document.querySelectorAll(".todo");
            tasks.forEach(function(task) {
                const taskText = task.querySelector(".task-title").innerText.toLowerCase();
                if (taskText.includes(searchInput)) {
                    task.style.display = "flex";
                } else {
                    task.style.display = "none";
                }
            });
        }

        // Sort Tasks
        function sortTasks() {
            const sortValue = document.getElementById('sortBy').value;
            const todoList = document.querySelector('.todo-list');
            let tasks = Array.from(todoList.querySelectorAll('.todo'));
            
            let sortedTasks = tasks.sort((a, b) => {
                if (sortValue === 'priority') {
                    const order = { 'high': 1, 'medium': 2, 'low': 3 };
                    return order[a.dataset.priority] - order[b.dataset.priority];
                }
                if (sortValue === 'dueDate') {
                    return new Date(a.dataset.dueDate) - new Date(b.dataset.dueDate);
                }
                return 0;
            });

            sortedTasks.forEach(task => todoList.appendChild(task));
        }

        // Delete All Tasks
        function deleteAllTasks() {
            if (confirm("Are you sure you want to delete all tasks? This action cannot be undone!")) {
                const todoList = document.querySelector('.todo-list');
                todoList.innerHTML = '';
                tasksData = [];
                updateStats();
                alert("All tasks have been deleted!");
            }
        }

        // Analysis Modal
        function openAnalysisModal() {
            document.getElementById("analysisModal").style.display = "flex";
            const totalTasks = document.querySelectorAll(".todo").length;
            const completedTasks = document.querySelectorAll(".todo.completed").length;
            const remainingTasks = totalTasks - completedTasks;
            const productivity = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            document.getElementById("productivityScore").innerText = `Productivity Score: ${productivity}%`;
            
            if (window.productivityChartInstance) {
                window.productivityChartInstance.destroy();
            }
            
            const ctx = document.getElementById("productivityChart").getContext("2d");
            window.productivityChartInstance = new Chart(ctx, {
                type: "doughnut",
                data: {
                    labels: ["Completed", "Remaining"],
                    datasets: [{
                        data: [completedTasks, remainingTasks],
                        backgroundColor: ["#059669", "#ef4444"],
                        borderWidth: 0
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            display: true,
                            position: 'bottom'
                        } 
                    }
                }
            });
        }
        
        function closeAnalysisModal() {
            document.getElementById("analysisModal").style.display = "none";
        }

        // Main App Logic
        let tasksData = [];
        
        document.addEventListener("DOMContentLoaded", function() {
            const taskForm = document.getElementById("taskForm");
            const todoList = document.querySelector(".todo-list");
            const addSubtaskBtn = document.getElementById("addSubtaskBtn");
            const subtaskList = document.getElementById("subtask-list");
            const state1 = document.getElementById("state1");
            const state2 = document.getElementById("state2");
            const state3 = document.getElementById("state3");
            const emptyMessage = document.getElementById("emptyMessage");
            
            const storageKey = "tasks_demo";

            // Make updateStats global so deleteAllTasks can access it
            window.updateStats = function() {
                const total = document.querySelectorAll(".todo").length;
                const completed = document.querySelectorAll(".todo.completed").length;
                state1.textContent = total;
                state2.textContent = total - completed;
                state3.textContent = completed;
                emptyMessage.style.display = total === 0 ? "block" : "none";
                updateProgressBar();
            }

            function updateProgressBar() {
                const total = parseInt(state1.textContent) || 0;
                const completed = parseInt(state3.textContent) || 0;
                const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
                const progressBar = document.getElementById("taskProgressBar");
                progressBar.style.width = percentage + "%";
                progressBar.textContent = percentage + "%";
            }

            function loadTasks() {
                tasksData.forEach(taskData => renderTask(taskData));
                updateStats();
            }

            function saveTasks() {
                tasksData = [];
                document.querySelectorAll(".todo").forEach(todoDiv => {
                    tasksData.push({
                        taskTitle: todoDiv.dataset.taskTitle,
                        startDate: todoDiv.dataset.startDate,
                        dueDate: todoDiv.dataset.dueDate,
                        reminderDate: todoDiv.dataset.reminderDate,
                        priority: todoDiv.dataset.priority,
                        stage: todoDiv.dataset.stage,
                        completed: todoDiv.classList.contains("completed"),
                        notes: todoDiv.dataset.notes || "",
                        subtasks: Array.from(todoDiv.querySelectorAll(".subtask-item")).map(item => ({
                            title: item.dataset.title,
                            status: item.classList.contains("completed") ? "completed" : "pending",
                            date: item.dataset.date || ""
                        }))
                    });
                });
            }

            function renderTask(taskData) {
                const todoDiv = document.createElement("div");
                todoDiv.classList.add("todo");
                if (taskData.completed) todoDiv.classList.add("completed");

                todoDiv.dataset.priority = taskData.priority.toLowerCase();
                todoDiv.dataset.taskTitle = taskData.taskTitle;
                todoDiv.dataset.startDate = taskData.startDate;
                todoDiv.dataset.dueDate = taskData.dueDate;
                todoDiv.dataset.stage = taskData.stage;
                if (taskData.reminderDate) todoDiv.dataset.reminderDate = taskData.reminderDate;
                if (taskData.notes) todoDiv.dataset.notes = taskData.notes;

                const newTask = document.createElement("li");
                newTask.classList.add("todo-item");
                newTask.innerHTML = `
                    <div class="task-content">
                        <div class="task-header">
                            <h5 class="task-title">${taskData.taskTitle}</h5>
                            <div class="d-flex gap-2">
                                <span class="badge ${taskData.priority.toLowerCase()}-priority">${taskData.priority}</span>
                                <span class="badge" style="background-color: var(--text-secondary);">${taskData.stage}</span>
                            </div>
                        </div>
                        <div class="task-dates">
                            <i class="far fa-calendar-alt me-1"></i>
                            ${taskData.startDate} → ${taskData.dueDate}
                        </div>
                        ${taskData.subtasks?.length > 0 ? `
                            <div class="subtasks-section">
                                <small class="d-block mb-2"><strong>Subtasks:</strong></small>
                                <ul class="subtasks-list">
                                    ${taskData.subtasks.map(st => `
                                        <li class="subtask-item ${st.status === 'completed' ? 'completed' : ''}" data-title="${st.title}" data-date="${st.date || ''}">
                                            <i class="fas fa-circle me-2" style="font-size: 0.4rem;"></i>${st.title}
                                            ${st.date ? `<small class="ms-2">(${st.date})</small>` : ''}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        ${taskData.notes ? `
                            <details class="notes-section">
                                <summary><small><i class="fas fa-sticky-note me-1"></i>View Notes</small></summary>
                                <p class="notes-text">${taskData.notes}</p>
                            </details>
                        ` : ''}
                    </div>
                `;

                todoDiv.appendChild(newTask);

                const completedBtn = document.createElement("button");
                completedBtn.innerHTML = '<i class="fas fa-check"></i>';
                completedBtn.classList.add("complete-btn");
                completedBtn.title = "Mark as complete";
                completedBtn.onclick = () => {
                    todoDiv.classList.toggle("completed");
                    window.updateStats();
                    saveTasks();
                };
                todoDiv.appendChild(completedBtn);

                const trashBtn = document.createElement("button");
                trashBtn.innerHTML = '<i class="fas fa-trash"></i>';
                trashBtn.classList.add("trash-btn");
                trashBtn.title = "Delete task";
                trashBtn.onclick = () => {
                    if (confirm("Delete this task?")) {
                        todoDiv.remove();
                        window.updateStats();
                        saveTasks();
                    }
                };
                todoDiv.appendChild(trashBtn);

                todoList.appendChild(todoDiv);
            }

            // Add Subtask
            addSubtaskBtn.addEventListener("click", function() {
                const row = document.createElement("div");
                row.className = "subtask-row d-flex gap-2 align-items-center mb-2";
                row.innerHTML = `
                    <input type="text" name="subtaskTitle[]" placeholder="Subtask title" class="form-control">
                    <select name="subtaskStatus[]" class="form-select">
                        <option value="pending">Pending</option>
                        <option value="completed">Completed</option>
                    </select>
                    <input type="date" name="subtaskDate[]" class="form-control">
                    <button type="button" class="btn btn-outline-danger btn-sm remove-subtask">×</button>
                `;
                row.querySelector(".remove-subtask").addEventListener("click", () => row.remove());
                subtaskList.appendChild(row);
            });

            // Submit Form
            taskForm.addEventListener("submit", function(e) {
                e.preventDefault();
                
                const taskTitle = document.getElementById("taskTitle").value.trim();
                if (!taskTitle) {
                    alert("Please enter a task title!");
                    return;
                }

                const taskData = {
                    taskTitle,
                    startDate: document.getElementById("startDate").value || new Date().toISOString().split('T')[0],
                    dueDate: document.getElementById("dueDate").value || new Date().toISOString().split('T')[0],
                    priority: document.getElementById("priorityInput").value,
                    stage: document.getElementById("stageSelect").value,
                    completed: false,
                    notes: document.getElementById("taskNotes").value.trim(),
                    reminderDate: document.getElementById('deadlineTime').value || null,
                    subtasks: Array.from(subtaskList.querySelectorAll(".subtask-row")).map(row => ({
                        title: row.querySelector('input[name="subtaskTitle[]"]').value.trim(),
                        status: row.querySelector('select[name="subtaskStatus[]"]').value,
                        date: row.querySelector('input[name="subtaskDate[]"]').value
                    })).filter(st => st.title)
                };

                renderTask(taskData);
                window.updateStats();
                saveTasks();
                
                taskForm.reset();
                subtaskList.innerHTML = "";
                
                const taskModalInstance = bootstrap.Modal.getInstance(document.getElementById('taskModal'));
                if (taskModalInstance) {
                    taskModalInstance.hide();
                }
                
                alert("Task added successfully!");
            });

            function loadTasks() {
                tasksData.forEach(taskData => renderTask(taskData));
                window.updateStats();
            }

            // Timeline Modal
            const timelineModal = document.getElementById('timelineModal');
            let fpInstance = null;

            timelineModal.addEventListener('shown.bs.modal', () => {
                if (fpInstance) fpInstance.destroy();
                
                const calDiv = document.getElementById('calendar');
                calDiv.innerHTML = '<input type="text" id="flatpickr-input" style="display:none;">';
                
                fpInstance = flatpickr("#flatpickr-input", {
                    inline: true,
                    mode: "range",
                    clickOpens: false,
                    allowInput: false,
                    disableMobile: true,
                    defaultDate: new Date(),
                    appendTo: calDiv
                });

                const firstTask = document.querySelector('.todo');
                const notice = document.getElementById('calendarNotice');
                
                if (!firstTask) {
                    notice.textContent = 'No tasks found. Create a task to see the timeline!';
                } else {
                    notice.textContent = `Displaying: "${firstTask.dataset.taskTitle}"`;
                }
            });

            loadTasks();
        });
    </script>
</body>
</html>